<link rel="import" href="polymer/polymer.html">
<link rel="import" href="todo-list.html">
<link rel="import" href="core-icon-button/core-icon-button.html">
<link rel="import" href="core-header-panel/core-header-panel.html"/>
<link rel="import" href="core-toolbar/core-toolbar.html"/>
<link rel="import" href="paper-dialog/paper-dialog.html"/>
<link rel="import" href="paper-input/paper-input-decorator.html"/>
<link rel="import" href="paper-button/paper-button.html"/>
<link rel="import" href="core-ajax/core-ajax.html"/>
<link rel="import" href="core-localstorage/core-localstorage.html"/>
<link rel="import" href="core-input/core-input.html"/>


<polymer-element name="todo-app">
    <template>
        <style>
           :host {
               display: block;
               height: 100%;
           }
           core-header-panel {
               height: 100%;
           }
            core-toolbar {
                background-color: #B3E5FC;
                color: white;
            }
            .loginView {
                background-color: #00BCD4;
            }
        </style>
        <template if="{{ loggedIn === 'true' }}">
            <core-header-panel>
                <core-toolbar>
                    <div flex>{{ name }}</div>
                    <core-icon-button icon="add" on-tap="{{addList}}"></core-icon-button>
                </core-toolbar>
                <div layout horizontal wrap justified>
                    <template repeat="{{ todoList in todoLists }}">
                        <todo-list data="{{ todoList }}"></todo-list>
                    </template>
                </div>
            </core-header-panel>
        </template>
        <template if="{{ loggedIn !== 'true' }}">
            <div class="loginView" fit>
                <paper-dialog heading="Welcome!" transition="core-transition-center"  autoCloseDisabled="true" id="loginDialog">
                    <div class="loginDialog">
                        <div layout horizontal>
                            <paper-input-decorator flex label="Name" floatingLabel="true" id="name">
                                <input is="core-input" required value="{{ name }}">
                            </paper-input-decorator>
                        </div>
                        <div layout horizontal>
                            <paper-input-decorator flex label="Secret key" floatingLabel="true" id="key">
                                <input is="core-input" required value="{{ secretKey }}">
                            </paper-input-decorator>
                        </div>
                        <div layout horizontal>
                            <paper-button raised flex on-tap="{{ submitForm }}">
                                Submit
                            </paper-button>
                        </div>
                    </div>
                </paper-dialog>
            </div>
            <core-ajax id="ajax"
                       url="/api/secret"
                       method="POST"
                       body='{"name": "{{name}}", "secretKey": "{{secretKey}}" }'
                       on-core-response="{{ onSuccess }}"
                       on-core-error="{{ onError }}"
                       handleAs="json">
            </core-ajax>
        </template>
        <core-localstorage id="loggedstate" name="loggedstate" value="{{ loggedIn }}" on-core-localstorage-load="{{ onStateLoad }}"></core-localstorage>
    </template>
    <script>
        Polymer({
            ready: function() {
                this.todoLists = [];
            },
            addList: function() {
                console.log('add');
                this.todoLists.push(1);
            },
            submitForm: function() {
                var name = this.$.name;
                var key = this.$.key;

                key.isInvalid = false;
                key.error = '';
                name.validate();
                key.validate();
                if (name.isInvalid || key.isInvalid) {
                    return;
                }
                this.$.ajax.go();
            },
            onSuccess: function() {
                this.$.loginDialog.opened = false;
                this.$.loggedstate.value = 'true';
            },
            onError: function() {
                var key = this.$.key;
                key.isInvalid = true;
                key.error = 'Wrong secret key';
            },
            onStateLoad: function() {
                if (this.$.loggedstate.value !== 'true') {
                    this.$.loginDialog.opened = true;
                }
            }
        });
    </script>
</polymer-element>